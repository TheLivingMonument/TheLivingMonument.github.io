<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plot Sensor Data</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; background: #f9fdf9; }
    header, footer { text-align: center; padding: 2rem 1rem; }
    header { background: linear-gradient(135deg, #2a7a3b, #46b96c); color: white; }
    header h1 { margin: 0 0 0.5rem; font-size: 2.2rem; }
    main { max-width: 1000px; margin: auto; padding: 2rem 1rem; }
    .card { background: white; padding: 1.5rem; border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 2rem; }
    h2 { color: #2a7a3b; margin-bottom: 1rem; }
    .chart { width: 100%; height: 400px; }
    footer { background: #eee; font-size: 0.9rem; }
  </style>
</head>
<body>
  <header>
    <h1>Plot Sensor Data</h1>
  </header>

  <main id="charts">
    <!-- I grafici verranno inseriti qui -->
  </main>

  <footer>
    <p>Sensor monitoring dashboard</p>
  </footer>

  <script>
    const csvFile = "data/livingMonumentData.txt";
    const sensors = [
      { index: 1, name: "pH", color: "#2a7a3b" },
      { index: 2, name: "TDS (ppm)", color: "#1f77b4" },
      { index: 3, name: "Temperature (Â°C)", color: "#ff7f0e" },
      { index: 4, name: "Humidity (%)", color: "#9467bd" },
      { index: 5, name: "Light (lux)", color: "#8c564b" },
      { index: 6, name: "Water Level", color: "#e377c2" }
    ];

    function createChart(containerId, title, x, y, color) {
      const trace = {
        x: x,
        y: y,
        type: "scatter",
        mode: "lines",
        line: { color: color },
        name: title
      };
      const layout = {
        margin: { t: 30 },
        title: title,
        xaxis: { title: "Time" },
        yaxis: { title: title }
      };
      Plotly.newPlot(containerId, [trace], layout, {responsive: true});
    }

    function loadData() {
      Papa.parse(csvFile, {
        download: true,
        delimiter: ",",
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: function(results) {
          const rows = results.data;

          // converte timestamp in Date
          const data = rows.map(r => ({
            timestamp: new Date(r[0].replace(" ", "T")),
            values: r.slice(1, 7)
          }));

          const times = data.map(d => d.timestamp);

          sensors.forEach(sensor => {
            const values = data.map(d => d.values[sensor.index - 1]);
            const chartId = sensor.name.replace(/\s+/g, "-") + "-chart";

            // crea il contenitore se non esiste
            if (!document.getElementById(chartId)) {
              const section = document.createElement("section");
              section.className = "card";
              section.innerHTML = `<h2>${sensor.name}</h2><div id="${chartId}" class="chart"></div>`;
              document.getElementById("charts").appendChild(section);
            }

            createChart(chartId, sensor.name, times, values, sensor.color);
          });
        }
      });
    }

    loadData();
    setInterval(loadData, 10000); // aggiorna ogni 10s
  </script>
</body>
</html>
