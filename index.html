<script>
const csvFile = "data/livingMonumentData.txt";

// sensori in ordine, corrispondente alle colonne (senza timestamp)
const sensors = [
  { name: "pH", color: "#2a7a3b" },
  { name: "TDS (ppm)", color: "#1f77b4" },
  { name: "Temperature (Â°C)", color: "#ff7f0e" },
  { name: "Humidity (%)", color: "#9467bd" },
  { name: "Light (lux)", color: "#8c564b" },
  { name: "Water Level", color: "#e377c2" }
];

function createChart(containerId, title, x, y, color) {
  const trace = {
    x: x,
    y: y,
    type: "scatter",
    mode: "lines",
    line: { color: color },
    name: title
  };
  const layout = {
    margin: { t: 30 },
    title: title,
    xaxis: { title: "Time" },
    yaxis: { title: title }
  };
  Plotly.newPlot(containerId, [trace], layout, {responsive: true});
}

function loadData() {
  Papa.parse(csvFile, {
    download: true,
    dynamicTyping: true,
    complete: function(results) {
      // filtriamo solo le righe valide e convertiamo il timestamp
      const now = new Date();
      const data = results.data.filter(r => r.length >= 7).map(r => {
        return {
          timestamp: new Date(r[0].replace(" ", "T")), // trasforma "YYYY-mm-dd hh:mm:ss" in ISO
          values: r.slice(1, 7) // colonne dei sensori
        };
      }).filter(r => now - r.timestamp <= 10*60*1000); // ultimi 10 minuti

      const times = data.map(r => r.timestamp);

      sensors.forEach((sensor, idx) => {
        const values = data.map(r => r.values[idx]);
        const chartId = "sensor-" + idx + "-chart";

        if (!document.getElementById(chartId)) {
          const section = document.createElement("section");
          section.className = "card";
          section.innerHTML = `<h2>${sensor.name}</h2><div id="${chartId}" class="chart"></div>`;
          document.getElementById("charts").appendChild(section);
        }

        createChart(chartId, sensor.name, times, values, sensor.color);
      });
    }
  });
}

// carica inizialmente
loadData();
// aggiorna ogni 10 secondi
setInterval(loadData, 10000);
</script>
